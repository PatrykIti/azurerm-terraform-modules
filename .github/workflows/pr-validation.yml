name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

permissions:
  contents: read
  pull-requests: write
  statuses: write

jobs:
  validate-pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    
    steps:
      - name: Check PR title follows conventional commits
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          scopes: |
            storage-account
            virtual-network
            key-vault
            app-service
            sql-database
            core
            deps
          requireScope: false
          subjectPattern: ^(?![A-Z]).+$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            didn't match the configured pattern. Please ensure that the subject
            doesn't start with an uppercase character.
          validateSingleCommit: false

  validate-commits:
    name: Validate Commit Messages
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check commit messages
        run: |
          # Get all commits in PR
          commits=$(git log --format="%H %s" origin/${{ github.base_ref }}..HEAD)
          
          # Conventional commit pattern
          pattern="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .+"
          
          invalid_commits=()
          while IFS= read -r commit; do
            hash=$(echo "$commit" | cut -d' ' -f1)
            message=$(echo "$commit" | cut -d' ' -f2-)
            
            if ! echo "$message" | grep -qE "$pattern"; then
              invalid_commits+=("$hash: $message")
            fi
          done <<< "$commits"
          
          if [ ${#invalid_commits[@]} -gt 0 ]; then
            echo "‚ùå The following commits do not follow conventional commit format:"
            printf '%s\n' "${invalid_commits[@]}"
            echo ""
            echo "Please use the conventional commit format:"
            echo "  <type>(<scope>): <subject>"
            echo ""
            echo "Example: feat(storage-account): add support for private endpoints"
            exit 1
          else
            echo "‚úÖ All commits follow conventional commit format"
          fi

  terraform-fmt:
    name: Terraform Format Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest
      
      - name: Check Terraform formatting
        id: fmt
        run: |
          # Find all directories with Terraform files
          tf_dirs=$(find . -name "*.tf" -exec dirname {} \; | sort -u | grep -v ".terraform")
          
          fmt_issues=()
          for dir in $tf_dirs; do
            echo "Checking format in: $dir"
            if ! terraform fmt -check -recursive "$dir"; then
              fmt_issues+=("$dir")
            fi
          done
          
          if [ ${#fmt_issues[@]} -gt 0 ]; then
            echo "‚ùå Terraform formatting issues found in:"
            printf '%s\n' "${fmt_issues[@]}"
            echo ""
            echo "Please run 'terraform fmt -recursive' to fix formatting issues."
            echo "fmt_needed=true" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "‚úÖ All Terraform files are properly formatted"
            echo "fmt_needed=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Comment formatting instructions
        if: failure() && steps.fmt.outputs.fmt_needed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ‚ùå Terraform Formatting Required
            
            This PR has Terraform formatting issues. Please run the following command to fix them:
            
            \`\`\`bash
            terraform fmt -recursive
            \`\`\`
            
            Then commit and push the changes.`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    needs: terraform-fmt
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest
      
      - name: Validate Terraform configurations
        run: |
          # Find all modules
          modules=$(find . -name "main.tf" -o -name "versions.tf" | grep -v ".terraform" | xargs -I {} dirname {} | sort -u)
          
          validation_failed=false
          for module in $modules; do
            echo "## Validating module: $module"
            cd "$module"
            
            # Initialize without backend
            if terraform init -backend=false; then
              if ! terraform validate; then
                echo "‚ùå Validation failed for module: $module"
                validation_failed=true
              else
                echo "‚úÖ Module validated successfully: $module"
              fi
            else
              echo "‚ùå Failed to initialize module: $module"
              validation_failed=true
            fi
            
            cd - > /dev/null
          done
          
          if [ "$validation_failed" = true ]; then
            exit 1
          fi

  tflint:
    name: TFLint Analysis
    runs-on: ubuntu-latest
    needs: terraform-fmt
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Cache tflint plugins
        uses: actions/cache@v3
        with:
          path: ~/.tflint.d/plugins
          key: ${{ runner.os }}-tflint-${{ hashFiles('.tflint.hcl') }}
          restore-keys: |
            ${{ runner.os }}-tflint-
      
      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest
      
      - name: Initialize TFLint
        run: |
          tflint --init
          echo "TFLint version:"
          tflint --version
      
      - name: Run TFLint on all modules
        id: tflint
        run: |
          # Find all modules
          modules=$(find modules -name "*.tf" -exec dirname {} \; | sort -u | grep -v ".terraform")
          
          tflint_failed=false
          tflint_output=""
          
          for module in $modules; do
            echo "## Running TFLint on: $module"
            
            # Run tflint and capture output
            if output=$(tflint --format=default --force "$module" 2>&1); then
              echo "‚úÖ TFLint passed for: $module"
              echo "$output"
            else
              echo "‚ùå TFLint found issues in: $module"
              echo "$output"
              tflint_failed=true
              tflint_output="${tflint_output}\n### Module: $module\n\`\`\`\n${output}\n\`\`\`\n"
            fi
            echo ""
          done
          
          # Also run on examples
          if [[ -d "examples" ]]; then
            examples=$(find examples -name "*.tf" -exec dirname {} \; | sort -u | grep -v ".terraform")
            for example in $examples; do
              echo "## Running TFLint on example: $example"
              
              if output=$(tflint --format=default --force "$example" 2>&1); then
                echo "‚úÖ TFLint passed for: $example"
                echo "$output"
              else
                echo "‚ùå TFLint found issues in: $example"
                echo "$output"
                tflint_failed=true
                tflint_output="${tflint_output}\n### Example: $example\n\`\`\`\n${output}\n\`\`\`\n"
              fi
              echo ""
            done
          fi
          
          if [ "$tflint_failed" = true ]; then
            echo "tflint_failed=true" >> $GITHUB_OUTPUT
            echo "tflint_output<<EOF" >> $GITHUB_OUTPUT
            echo -e "$tflint_output" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "tflint_failed=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Comment TFLint results
        if: failure() && steps.tflint.outputs.tflint_failed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `${{ steps.tflint.outputs.tflint_output }}`;
            const comment = `## ‚ö†Ô∏è TFLint Found Issues
            
            TFLint has identified code quality issues that need to be addressed:
            
            ${output}
            
            Please fix these issues before merging. You can run TFLint locally with:
            
            \`\`\`bash
            tflint --init
            tflint --format=default --force <module-directory>
            \`\`\``;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  documentation-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install terraform-docs
        run: |
          curl -sSLo ./terraform-docs.tar.gz https://github.com/terraform-docs/terraform-docs/releases/download/v0.17.0/terraform-docs-v0.17.0-linux-amd64.tar.gz
          tar -xzf terraform-docs.tar.gz
          chmod +x terraform-docs
          sudo mv terraform-docs /usr/local/bin/
      
      - name: Check if documentation is up to date
        id: docs
        run: |
          # Find all modules
          modules=$(find . -name "main.tf" -o -name "versions.tf" | grep -v ".terraform" | xargs -I {} dirname {} | sort -u | grep -E "^\\./azurerm_")
          
          docs_outdated=()
          for module in $modules; do
            if [[ -f "$module/README.md" ]]; then
              # Generate current documentation
              terraform-docs markdown table --output-file README.md.tmp "$module"
              
              # Compare with existing
              if ! diff -q "$module/README.md" "$module/README.md.tmp" > /dev/null 2>&1; then
                docs_outdated+=("$module")
              fi
              
              rm -f "$module/README.md.tmp"
            else
              docs_outdated+=("$module (missing README.md)")
            fi
          done
          
          if [ ${#docs_outdated[@]} -gt 0 ]; then
            echo "‚ùå Documentation is outdated or missing in:"
            printf '%s\n' "${docs_outdated[@]}"
            echo "docs_outdated=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ All documentation is up to date"
            echo "docs_outdated=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Comment documentation instructions
        if: steps.docs.outputs.docs_outdated == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## üìö Documentation Update Required
            
            The documentation for some modules is outdated or missing. Please update it by running:
            
            \`\`\`bash
            # For each module that needs updating:
            terraform-docs markdown table --output-file README.md <module-directory>
            \`\`\`
            
            Or update all modules:
            \`\`\`bash
            find . -name "main.tf" -exec dirname {} \\; | xargs -I {} terraform-docs markdown table --output-file {}/README.md {}
            \`\`\``;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Run Checkov scan
        id: checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: terraform
          soft_fail: true
          output_format: json
          output_file_path: checkov-results.json
      
      - name: Process security results
        if: always()
        run: |
          if [[ -f checkov-results.json ]]; then
            failed=$(jq '.summary.failed' checkov-results.json)
            passed=$(jq '.summary.passed' checkov-results.json)
            
            echo "## Security Scan Summary"
            echo "- Passed checks: $passed"
            echo "- Failed checks: $failed"
            
            if [[ $failed -gt 0 ]]; then
              echo ""
              echo "### Failed Checks:"
              jq -r '.results.failed_checks[] | "- [\(.check_id)] \(.check_name) in \(.file_path)"' checkov-results.json
            fi
          fi

  quality-gates:
    name: Quality Gates Summary
    runs-on: ubuntu-latest
    needs: [validate-pr-title, validate-commits, terraform-fmt, terraform-validate, tflint, documentation-check, security-scan]
    if: always()
    
    steps:
      - name: Quality gates summary
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = ${{ toJSON(needs) }};
            const jobNames = {
              'validate-pr-title': 'PR Title Validation',
              'validate-commits': 'Commit Message Validation',
              'terraform-fmt': 'Terraform Formatting',
              'terraform-validate': 'Terraform Validation',
              'tflint': 'TFLint Analysis',
              'documentation-check': 'Documentation Check',
              'security-scan': 'Security Scan'
            };
            
            let allPassed = true;
            let summary = '## üîç PR Validation Summary\n\n';
            summary += '| Check | Status |\n';
            summary += '|-------|--------|\n';
            
            for (const [job, result] of Object.entries(jobs)) {
              const status = result.result === 'success' ? '‚úÖ Passed' : '‚ùå Failed';
              if (result.result !== 'success') allPassed = false;
              summary += `| ${jobNames[job]} | ${status} |\n`;
            }
            
            summary += '\n';
            
            if (allPassed) {
              summary += '### ‚úÖ All quality gates passed!\n\n';
              summary += 'This PR is ready for review.';
            } else {
              summary += '### ‚ùå Some quality gates failed\n\n';
              summary += 'Please address the failing checks before this PR can be merged.';
            }
            
            // Find and update existing comment or create new one
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('PR Validation Summary')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: summary
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
            }